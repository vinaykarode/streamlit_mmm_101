<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propensity Score Matching - Email Campaign Example</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #1a202c;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .scenario {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .scenario-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .scenario-text {
            color: #4a5568;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #667eea;
            color: white;
            transform: scale(1.2);
        }

        .step.complete .step-circle {
            background: #48bb78;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
        }

        .visualization-area {
            margin: 30px 0;
            min-height: 400px;
        }

        .groups-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .group {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .group-header {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-treated {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-control {
            background: #fed7d7;
            color: #742a2a;
        }

        .user-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            opacity: 1;
        }

        .user-card.matching {
            animation: pulse 1s ease-in-out infinite;
        }

        .user-card.matched {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .user-card.faded {
            opacity: 0.3;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .user-name {
            font-weight: 700;
            color: #2d3748;
            font-size: 14px;
        }

        .user-info {
            font-size: 12px;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .propensity-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .propensity-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease-out;
            width: 0;
        }

        .propensity-fill.animate {
            animation: fillBar 1s ease-out forwards;
        }

        @keyframes fillBar {
            from { width: 0; }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .result-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 36px;
            font-weight: 700;
            color: #2d3748;
        }

        .result-subtext {
            font-size: 14px;
            color: #4a5568;
            margin-top: 4px;
        }

        .highlight {
            background: #fef5e7;
            padding: 20px;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            margin: 20px 0;
        }

        .highlight-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 10px;
        }

        .highlight-text {
            color: #78350f;
            line-height: 1.6;
        }

        .matched-pairs {
            margin-top: 30px;
        }

        .pair-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            opacity: 0;
            animation: slideIn 0.5s ease-out forwards;
        }

        .pair-connector {
            font-size: 24px;
            color: #48bb78;
        }

        .conversion-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 6px;
        }

        .converted {
            background: #c6f6d5;
            color: #22543d;
        }

        .not-converted {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Propensity Score Matching: Real Example</h1>
        
        <div class="scenario">
            <div class="scenario-title">üìß Scenario: Premium Upgrade Email Campaign</div>
            <div class="scenario-text">
                You sent a "Upgrade to Premium" email to 5,000 users. 200 upgraded within 7 days.
                <br><br>
                <strong>Question:</strong> Did the email cause those upgrades, or would they have upgraded anyway?
                <br><br>
                <strong>The Problem:</strong> Users who received the email aren't random. Your email system targeted:
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>Active users (logged in 5+ times last week)</li>
                    <li>Power users (used advanced features)</li>
                    <li>Engaged users (high session duration)</li>
                </ul>
                These users were already more likely to upgrade. We need PSM to separate email impact from user intent.
            </div>
        </div>

        <div class="controls">
            <button id="step1Btn" onclick="app.showStep1()">Step 1: Show Groups</button>
            <button id="step2Btn" onclick="app.showStep2()" disabled>Step 2: Calculate Scores</button>
            <button id="step3Btn" onclick="app.showStep3()" disabled>Step 3: Match Twins</button>
            <button id="step4Btn" onclick="app.showStep4()" disabled>Step 4: Compare Results</button>
            <button onclick="app.reset()" style="margin-left: auto; background: #718096;">‚Ü∫ Reset</button>
        </div>

        <div class="step-indicator">
            <div class="step" id="indicator1">
                <div class="step-circle">1</div>
                <div class="step-label">Initial Groups</div>
            </div>
            <div class="step" id="indicator2">
                <div class="step-circle">2</div>
                <div class="step-label">Propensity Scores</div>
            </div>
            <div class="step" id="indicator3">
                <div class="step-circle">3</div>
                <div class="step-label">Match Twins</div>
            </div>
            <div class="step" id="indicator4">
                <div class="step-circle">4</div>
                <div class="step-label">True Impact</div>
            </div>
        </div>

        <div class="visualization-area" id="vizArea"></div>
    </div>

    <script>
        // Real-world user profiles
        const userProfiles = {
            treated: [
                { name: 'Sarah M.', activity: 'High', features: 8, sessions: 12, score: 0.82, upgraded: true },
                { name: 'James K.', activity: 'High', features: 7, sessions: 10, score: 0.78, upgraded: true },
                { name: 'Maria G.', activity: 'Medium', features: 5, sessions: 7, score: 0.65, upgraded: true },
                { name: 'David L.', activity: 'High', features: 9, sessions: 15, score: 0.88, upgraded: true },
                { name: 'Emily R.', activity: 'Medium', features: 6, sessions: 8, score: 0.71, upgraded: false },
                { name: 'Alex P.', activity: 'High', features: 8, sessions: 11, score: 0.80, upgraded: true },
                { name: 'Lisa W.', activity: 'Medium', features: 5, sessions: 6, score: 0.63, upgraded: false },
                { name: 'Tom H.', activity: 'High', features: 7, sessions: 9, score: 0.75, upgraded: true }
            ],
            control: [
                { name: 'Chris B.', activity: 'Low', features: 2, sessions: 3, score: 0.35, upgraded: false },
                { name: 'Nina S.', activity: 'Medium', features: 5, sessions: 7, score: 0.66, upgraded: false },
                { name: 'Mark T.', activity: 'Low', features: 3, sessions: 4, score: 0.42, upgraded: false },
                { name: 'Jessica F.', activity: 'High', features: 8, sessions: 11, score: 0.81, upgraded: false },
                { name: 'Ryan D.', activity: 'Low', features: 2, sessions: 2, score: 0.28, upgraded: false },
                { name: 'Amanda C.', activity: 'Medium', features: 6, sessions: 8, score: 0.70, upgraded: true },
                { name: 'Kevin Y.', activity: 'High', features: 7, sessions: 10, score: 0.77, upgraded: true },
                { name: 'Sophie L.', activity: 'Low', features: 3, sessions: 5, score: 0.45, upgraded: false },
                { name: 'Mike R.', activity: 'High', features: 9, sessions: 14, score: 0.86, upgraded: false },
                { name: 'Rachel N.', activity: 'Medium', features: 4, sessions: 6, score: 0.58, upgraded: false }
            ]
        };

        const app = {
            currentStep: 0,
            matches: [],

            reset() {
                this.currentStep = 0;
                this.matches = [];
                document.getElementById('step1Btn').disabled = false;
                document.getElementById('step2Btn').disabled = true;
                document.getElementById('step3Btn').disabled = true;
                document.getElementById('step4Btn').disabled = true;
                
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`indicator${i}`).classList.remove('active', 'complete');
                }
                
                document.getElementById('vizArea').innerHTML = '';
            },

            updateStepIndicator(step) {
                for (let i = 1; i <= 4; i++) {
                    const indicator = document.getElementById(`indicator${i}`);
                    indicator.classList.remove('active');
                    if (i < step) {
                        indicator.classList.add('complete');
                    }
                }
                document.getElementById(`indicator${step}`).classList.add('active');
            },

            showStep1() {
                this.currentStep = 1;
                this.updateStepIndicator(1);
                document.getElementById('step2Btn').disabled = false;

                const treatedRate = ((userProfiles.treated.filter(u => u.upgraded).length / userProfiles.treated.length) * 100).toFixed(1);
                const controlRate = ((userProfiles.control.filter(u => u.upgraded).length / userProfiles.control.length) * 100).toFixed(1);
                const naiveLift = (treatedRate - controlRate).toFixed(1);

                const html = `
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Step 1: The Biased Groups</h2>
                    
                    <div class="highlight" style="margin-bottom: 30px;">
                        <div class="highlight-title">‚ö†Ô∏è The Problem: Selection Bias</div>
                        <div class="highlight-text">
                            Notice the treated group has more "High" activity users and higher feature usage.
                            <br><br>
                            <strong>Naive comparison: ${treatedRate}% vs ${controlRate}% = ${naiveLift}% lift</strong>
                            <br>
                            But this is unfair! We're comparing power users (treated) to casual users (control).
                        </div>
                    </div>

                    <div class="groups-container">
                        <div class="group">
                            <div class="group-header">
                                <span>üìß Received Email</span>
                                <span class="badge badge-treated">Treated Group</span>
                            </div>
                            ${userProfiles.treated.map(user => `
                                <div class="user-card">
                                    <div class="user-header">
                                        <span class="user-name">${user.name}</span>
                                    </div>
                                    <div class="user-info">Activity: ${user.activity} | Features Used: ${user.features}</div>
                                    <div class="user-info">Weekly Sessions: ${user.sessions}</div>
                                    <span class="conversion-badge ${user.upgraded ? 'converted' : 'not-converted'}">
                                        ${user.upgraded ? '‚úì Upgraded' : '‚úó No Upgrade'}
                                    </span>
                                </div>
                            `).join('')}
                            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                                <strong>Conversion Rate: ${treatedRate}%</strong>
                            </div>
                        </div>
                        <div class="group">
                            <div class="group-header">
                                <span>‚ùå No Email</span>
                                <span class="badge badge-control">Control Group</span>
                            </div>
                            ${userProfiles.control.map(user => `
                                <div class="user-card">
                                    <div class="user-header">
                                        <span class="user-name">${user.name}</span>
                                    </div>
                                    <div class="user-info">Activity: ${user.activity} | Features Used: ${user.features}</div>
                                    <div class="user-info">Weekly Sessions: ${user.sessions}</div>
                                    <span class="conversion-badge ${user.upgraded ? 'converted' : 'not-converted'}">
                                        ${user.upgraded ? '‚úì Upgraded' : '‚úó No Upgrade'}
                                    </span>
                                </div>
                            `).join('')}
                            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                                <strong>Conversion Rate: ${controlRate}%</strong>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('vizArea').innerHTML = html;
            },

            showStep2() {
                this.currentStep = 2;
                this.updateStepIndicator(2);
                document.getElementById('step3Btn').disabled = false;

                const html = `
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Step 2: Calculate Propensity Scores</h2>
                    
                    <div class="highlight" style="margin-bottom: 30px;">
                        <div class="highlight-title">üí° What Are Propensity Scores?</div>
                        <div class="highlight-text">
                            Propensity Score = Probability of receiving the email based on user behavior
                            <br><br>
                            <strong>Formula:</strong> f(activity level, features used, session frequency)
                            <br><br>
                            Higher scores = More likely to receive email (power users)
                            <br>
                            Lower scores = Less likely to receive email (casual users)
                        </div>
                    </div>

                    <div class="groups-container">
                        <div class="group">
                            <div class="group-header">
                                <span>üìß Received Email</span>
                            </div>
                            ${userProfiles.treated.map(user => `
                                <div class="user-card">
                                    <div class="user-header">
                                        <span class="user-name">${user.name}</span>
                                        <span style="font-size: 12px; color: #667eea; font-weight: 700;">${(user.score * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="user-info">Activity: ${user.activity} | Features: ${user.features} | Sessions: ${user.sessions}</div>
                                    <div class="propensity-bar">
                                        <div class="propensity-fill animate" style="width: ${user.score * 100}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="group">
                            <div class="group-header">
                                <span>‚ùå No Email</span>
                            </div>
                            ${userProfiles.control.map(user => `
                                <div class="user-card">
                                    <div class="user-header">
                                        <span class="user-name">${user.name}</span>
                                        <span style="font-size: 12px; color: #667eea; font-weight: 700;">${(user.score * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="user-info">Activity: ${user.activity} | Features: ${user.features} | Sessions: ${user.sessions}</div>
                                    <div class="propensity-bar">
                                        <div class="propensity-fill animate" style="width: ${user.score * 100}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.getElementById('vizArea').innerHTML = html;
            },

            showStep3() {
                this.currentStep = 3;
                this.updateStepIndicator(3);
                document.getElementById('step4Btn').disabled = false;

                // Find matches (within 5% propensity score)
                this.matches = [];
                const usedControls = new Set();
                
                userProfiles.treated.forEach(treated => {
                    let bestMatch = null;
                    let bestDiff = Infinity;
                    
                    userProfiles.control.forEach(control => {
                        if (!usedControls.has(control.name)) {
                            const diff = Math.abs(treated.score - control.score);
                            if (diff < 0.05 && diff < bestDiff) {
                                bestDiff = diff;
                                bestMatch = control;
                            }
                        }
                    });
                    
                    if (bestMatch) {
                        usedControls.add(bestMatch.name);
                        this.matches.push({ treated, control: bestMatch });
                    }
                });

                const html = `
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Step 3: Match Statistical Twins</h2>
                    
                    <div class="highlight" style="margin-bottom: 30px;">
                        <div class="highlight-title">üéØ Finding Statistical Twins</div>
                        <div class="highlight-text">
                            Matching control users with similar propensity scores (within 5% difference)
                            <br><br>
                            <strong>Found ${this.matches.length} matched pairs</strong>
                            <br><br>
                            These pairs have nearly identical likelihood of receiving the email.
                            <br>
                            The only difference: One got the email, one didn't.
                        </div>
                    </div>

                    <div class="matched-pairs">
                        ${this.matches.map((pair, idx) => `
                            <div class="pair-container" style="animation-delay: ${idx * 0.1}s">
                                <div class="user-card matched">
                                    <div class="user-header">
                                        <span class="user-name">${pair.treated.name}</span>
                                        <span class="badge badge-treated">Treated</span>
                                    </div>
                                    <div class="user-info">Score: ${(pair.treated.score * 100).toFixed(0)}% | ${pair.treated.activity} Activity</div>
                                    <span class="conversion-badge ${pair.treated.upgraded ? 'converted' : 'not-converted'}">
                                        ${pair.treated.upgraded ? '‚úì Upgraded' : '‚úó No Upgrade'}
                                    </span>
                                </div>
                                <div class="pair-connector">‚ü∑</div>
                                <div class="user-card matched">
                                    <div class="user-header">
                                        <span class="user-name">${pair.control.name}</span>
                                        <span class="badge badge-control">Control</span>
                                    </div>
                                    <div class="user-info">Score: ${(pair.control.score * 100).toFixed(0)}% | ${pair.control.activity} Activity</div>
                                    <span class="conversion-badge ${pair.control.upgraded ? 'converted' : 'not-converted'}">
                                        ${pair.control.upgraded ? '‚úì Upgraded' : '‚úó No Upgrade'}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('vizArea').innerHTML = html;
            },

            showStep4() {
                this.currentStep = 4;
                this.updateStepIndicator(4);

                const naiveTreatedRate = (userProfiles.treated.filter(u => u.upgraded).length / userProfiles.treated.length * 100).toFixed(1);
                const naiveControlRate = (userProfiles.control.filter(u => u.upgraded).length / userProfiles.control.length * 100).toFixed(1);
                const naiveLift = (naiveTreatedRate - naiveControlRate).toFixed(1);

                const matchedTreatedRate = (this.matches.filter(p => p.treated.upgraded).length / this.matches.length * 100).toFixed(1);
                const matchedControlRate = (this.matches.filter(p => p.control.upgraded).length / this.matches.length * 100).toFixed(1);
                const trueLift = (matchedTreatedRate - matchedControlRate).toFixed(1);

                const overcredit = (((naiveLift / trueLift) - 1) * 100).toFixed(0);
                const liftDiff = (naiveLift - trueLift).toFixed(1);

                const html = `
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Step 4: The True Causal Impact</h2>
                    
                    <div class="highlight" style="margin-bottom: 30px;">
                        <div class="highlight-title">üéØ The Bottom Line</div>
                        <div class="highlight-text">
                            <strong>You were overcrediting the email by ${overcredit}%!</strong>
                            <br><br>
                            ‚Ä¢ Naive approach claimed: ${naiveLift}% lift (comparing apples to oranges)
                            <br>
                            ‚Ä¢ PSM revealed: ${trueLift}% true causal lift (comparing statistical twins)
                            <br><br>
                            The email worked! But ${liftDiff} percentage points of the "lift" 
                            would have happened anyway because you targeted high-intent users.
                            <br><br>
                            <strong>This is why your CFO doesn't trust your attribution reports.</strong>
                        </div>
                    </div>
                    
                    <div style="background: #fff5f5; border: 2px solid #fc8181; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                        <h3 style="color: #c53030; margin-bottom: 15px;">‚ùå Naive Comparison (Biased)</h3>
                        <div class="results-grid">
                            <div class="result-card" style="border-color: #fc8181;">
                                <div class="result-label">Treated</div>
                                <div class="result-value" style="color: #c53030;">${naiveTreatedRate}%</div>
                                <div class="result-subtext">Got email</div>
                            </div>
                            <div class="result-card" style="border-color: #fc8181;">
                                <div class="result-label">Control</div>
                                <div class="result-value" style="color: #c53030;">${naiveControlRate}%</div>
                                <div class="result-subtext">No email</div>
                            </div>
                            <div class="result-card" style="border-color: #fc8181;">
                                <div class="result-label">Apparent Lift</div>
                                <div class="result-value" style="color: #c53030;">${naiveLift}%</div>
                                <div class="result-subtext">MISLEADING</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #2f855a; margin-bottom: 15px;">‚úÖ PSM Comparison (Unbiased)</h3>
                        <div class="results-grid">
                            <div class="result-card" style="border-color: #48bb78;">
                                <div class="result-label">Matched Treated</div>
                                <div class="result-value" style="color: #2f855a;">${matchedTreatedRate}%</div>
                                <div class="result-subtext">Statistical twins</div>
                            </div>
                            <div class="result-card" style="border-color: #48bb78;">
                                <div class="result-label">Matched Control</div>
                                <div class="result-value" style="color: #2f855a;">${matchedControlRate}%</div>
                                <div class="result-subtext">Statistical twins</div>
                            </div>
                            <div class="result-card" style="border-color: #48bb78;">
                                <div class="result-label">True Causal Lift</div>
                                <div class="result-value" style="color: #2f855a;">${trueLift}%</div>
                                <div class="result-subtext">REAL IMPACT</div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('vizArea').innerHTML = html;
            }
        };

        // Auto-start
        window.addEventListener('load', () => {
            app.reset();
        });
    </script>
</body>
</html>